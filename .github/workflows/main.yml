name: CI

on: [push]

jobs:
  test:
    runs-on: ${{â€Šmatrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        config: [Debug, Release]
        include:
        - os: windows-latest
          config: Debug
          args: -T ClangCL
        - os: windows-latest
          config: Release
          args: -T ClangCL
        - os: windows-latest
          config: Debug
        - os: windows-latest
          config: Release
    steps:
    - uses: actions/checkout@v2

    # Download the c-api directory
    - run: |
        curl -LO https://github.com/alexcrichton/abc/releases/download/a/tarballs.zip
        unzip tarballs.zip
        mkdir c-api
      shell: bash
    - run: |
        unzip wasmtime-dev-x86_64-windows-c-api.zip
        mv wasmtime-dev-x86_64-windows-c-api/* c-api
      if: matrix.os == 'windows-latest'
      shell: bash
    - run: tar xf wasmtime-dev-x86_64-macos-c-api.tar.xz -C c-api --strip-components=1
      if: matrix.os == 'macos-latest'
    - run: tar xf wasmtime-dev-x86_64-linux-c-api.tar.xz -C c-api --strip-components=1
      if: matrix.os == 'ubuntu-latest'

    # Configure CMake appropriately
    - run: cmake -B build ${{ matrix.args }}
      if: matrix.os == 'windows-latest'

    - run: |
        sudo apt-get update -y
        sudo apt-get install clang-tidy
        cmake -B build -DCMAKE_CXX_COMPILER=clang -DCMAKE_BUILD_TYPE=${{ matrix.config }}
      if: matrix.os == 'ubuntu-latest'

    - run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.config }}
      if: matrix.os == 'macos-latest'

    # and build!
    - run: cmake --build build --config ${{ matrix.config }} --verbose

